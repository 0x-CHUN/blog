# chapter 4

## 连接表达式

SQL提供了连接运算的其他形式，包括能够指定显式的连接谓词，能够在结果中包含被自然连接排除在外的元组；

### 连接条件

on条件允许在参与连接的关系上设置通用的谓词；

### 外连接

三种形式：

1. 左外连接：只保留出现在左外连接运算之前的关系中的元组
2. 右外连接：只保留出现在右外连接运算之后的关系中的元组
3. 全外连接：保留出现在两个关系中的元组

不保留未匹配元组的运算被称为**内连接**；

左外连接运算：计算出内连接的结果，然后对于在内连接的左侧关系中任意一个于右侧关系中任何元组都不匹配的元组t，向连接结果中加入一个元组r，r的构造如下：

* 元组r从左侧关系的得到的属性被赋值为t中的值
* r的其他属性赋值为空值

**左外连接和右外连接是对称的**；

**全外连接是左外连接于右外连接的组合**；

on子句可以与外连接一起使用；

## 视图

SQL允许通过查询来定义“虚关系”，它在概念上包含查询的结果，作为虚关系对用户可见的关系称为**视图**；

### 视图定义

格式：`create view v as <query expression>`

### 物化视图

特定数据库系统允许存储视图关系，如果用于定义视图的实际关系改变，视图也跟着修改，这样的视图被称为**物化视图**；

保持物化视图一致在最新状态的过程称为**物化视图维护**；

### 视图更新

视图表达的数据库修改必须翻译为数据库逻辑模型中实际关系的修改；

一般来说，如果定义的视图的查询满足：

* from子句中只有一个数据库关系
* select子句中只包含关系的属性名，不包含任何表达式、聚集或distinct声明
* 任何没有出现在select子句中的属性可以取空值
* 查询中不含有group by或having子句

则称视图是**可更新的**；

## 事务

事务由查询和更新语句的序列组成；SQL标准规定当一条语句执行时，就隐式地开始了一个事务。

结束事务的SQL语句：

* commit work：提交当前事务
* rollback work：回滚当前事务

## 完整性约束

完整性约束保证授权用户对数据库所做的修改不会破坏数据的一致性。

### 单个关系上的约束

`create table`命令中的允许的完整性约束：

* not null：禁止空值
* unique：指出属性形成了一个候选码，即不存在相同的值
* check子句：`check(p)`指定一个谓词，关系中的每个元组都必须满足谓词p

### 参照完整性

保证在以一个关系中给定的属性集上的取值也在另一关系的特定属性集的取值中出现，这称为**参照完整性**；

更一般的，令关系$r_1$和$r_2$的属性集分别为$R_1$和$R_2$，主码分别为$K_1$和$K_2$，如果要求对$r_2$中任意元组$t_2$，均存在$r_1$中元组$t_1$使得$t_1 * K_1 = t_2 * K_2$，称$R_2$的子集α为参照关系$r_1$中$K_1$的外码（foreign key)。

显式指定被参照关系的属性列表：`foreign key (x) reference x`

###  复杂check条件与断言

check子句中的谓词可以是包含子查询的任意谓词；

## SQL的数据类型与模式

### 日期和时间类型

* date：日历日期
* time：一天中的时间
* timestamp：date和time的组合

### 默认值

设定默认值用`default`

### 创建索引

在关系的属性上创建的索引加快了查询关系在索引属性上取给定的值的元组；

形式：`create index name on 关系(属性)`

### 大对象类型

SQL提供字符数据的大对象数据类型：`clob`、二进制数据的大对象数据类型：`blob`;

### 用户定义的类型

两种形式：

* 独特类型
* 结构化数据类型

定义新类型：`create type`

例子：

```sql
create type Dollars as numeric (12,2) final;
create type Pounds as numeric (12,2) final;
```

## 授权

### 权限的授予与收回

SQL包括select、insert、update和delete权限；

形式：

```sql
grant <权限列表>
on <关系名或视图名>
to <用户/角色列表>
```

### 角色

SQL支持在数据库中建立一个角色集，可以给角色授予权限；

形式：`create role 名字`

